# Mercor Airtable Automation Project
This project provides a suite of modular tools to manage a contractor application process using Airtable, Python, and the Google Gemini API. It automates data consolidation, enables easy editing, and uses AI to enrich and evaluate applicant profiles. The codebase is refactored for maintainability, extensibility, and robust error handling, with centralized configuration and utility modules (`airtable_utils.py`, `llm_utils.py`, `config.py`).

## Table of Contents

1. [Airtable Base Setup](#1-airtable-base-setup)
2. [Python Scripts & Utilities Setup](#2-python-scripts--utilities-setup)
3. [Running the Python Scripts](#3-running-the-python-scripts)
   * [llm_evaluate.py](#llm_evaluatepy)
   * [decompress.py](#decompresspy)
   * [shortlist.py](#shortlistpy)
   * [llm_utils.py](#llm_utilspy)
4. [Airtable Automations](#4-airtable-automations)
   * [Lead Shortlisting](#lead-shortlisting)
5. [Customization & Extensibility](#5-customization--extensibility)
6. [Error Handling & Logging](#6-error-handling--logging)
7. [Centralized Configuration](#7-centralized-configuration)
8. [Useful Links](#useful-links)

---

## 1. Airtable Base Setup

The base consists of five tables designed to normalize applicant data.

### Table Definitions

#### Applicants (Parent Table)
This is the central table. Each record represents one unique applicant.
- `Applicant ID` (Primary Field, Autonumber): A unique ID for each applicant.
- `Compressed JSON` (Long text): Stores the consolidated JSON object generated by `llm_evaluate.py`.
- `Shortlist Status` (Single select): Tracks the candidate's stage (e.g., "New", "Under Review", "Shortlisted").
- `LLM Summary`, `LLM Score`, `LLM Follow-Ups`: Fields populated by the `llm_utils.py` script.

#### Personal Details (Child Table)
Stores one record per applicant with their basic contact information.
- `Full Name` (Single line text)
- `Email` (Email)
- `Location` (Single select or text)
- `Applicant` (Link to `Applicants`): A **one-to-one** link. *Crucially, disable "Allow linking to multiple records".*

#### Work Experience (Child Table)
Stores multiple records per applicant, one for each previous job.
- `Company` (Single line text)
- `Title` (Single line text)
- `Start` (Date)
- `End` (Date)
- `Technologies` (Multi-select or text)
- `Applicant` (Link to `Applicants`): A **one-to-many** link.

#### Salary Preferences (Child Table)
Stores one record per applicant with their rate and availability.
- `Preferred Rate` (Number)
- `Currency` (Single select or text)
- `Minimum Rate` (Number)
- `Availability (hrs/wk)` (Number)
- `Applicant` (Link to `Applicants`): A **one-to-one** link. *Disable "Allow linking to multiple records".*

#### Shortlisted Leads (Helper Table)
A view of only the candidates who meet the shortlisting criteria.
- `Applicant` (Link to `Applicants`): Populated by an Airtable automation.
- `Compressed JSON` (Lookup): Looks up the JSON from the linked `Applicant`.
- `Score Reason` (Long text): A human-readable explanation of why the candidate was shortlisted.

---

## 2. Python Scripts & Utilities Setup

These scripts and utility modules run locally to interact with your Airtable base and the Gemini API. The codebase is designed for modularity and maintainability.

### Utility Modules
- `airtable_utils.py`: Contains the `AirtableClient` class for all Airtable API interactions. Handles authentication, CRUD operations, and uses `config.py` for table/field names and keys.
- `llm_utils.py`: Contains the `LLMClient` class for Gemini API calls. Implements token cap enforcement, exponential backoff, and centralized error handling/logging for all LLM operations.
- `config.py`: Centralizes all table names, field definitions, API keys, and constants. Update this file to add new tables, fields, or change configuration. All scripts and utilities import from this file for consistency.

### Scripts
- `llm_evaluate.py`: Consolidates applicant data from child tables into the `Compressed JSON` field in the `Applicants` table using `AirtableClient` and config.
- `decompress.py`: Reads the `Compressed JSON` field and updates child tables to match the JSON data, using `AirtableClient` and config.
- `shortlist.py`: Applies modular shortlisting criteria, updates `Shortlist Status`, and adds records to `Shortlisted Leads` using utility modules.

All scripts use robust error handling and logging via the utility modules. For extensibility, add new tables/fields in `config.py` and new logic in the utility modules.

### Installing Python Dependencies
Before running any scripts, install all required libraries using pip:

```powershell
pip install -r requirements.txt
```

Run this command in your terminal from the project directory. This will install all dependencies listed in `requirements.txt`.

---

## 3. Running the Python Scripts

You can run these scripts from your terminal.

### `llm_evaluate.py`
Evaluates applicants in the `Applicants` table who have a `Compressed JSON` profile but have not yet been evaluated by the LLM. Sends each JSON profile to the Gemini API and updates the `LLM Summary`, `LLM Score`, and `LLM Follow-Ups` fields.

**When to run it:** After new applicants have been consolidated into the `Compressed JSON` field.
**Command:**
```bash
python llm_evaluate.py
```

### `decompress.py`
Syncs the normalized child tables (`Personal Details`, `Work Experience`, `Salary Preferences`) from the `Compressed JSON` field in the `Applicants` table. Ensures Airtable records match the JSON data.

**When to run it:** After manually editing a `Compressed JSON` field and wanting to push changes to child tables.
**Command:**
```bash
python decompress.py
```

### `shortlist.py`
Applies complex shortlisting criteria in Python, using applicant data and LLM checks. Updates `Shortlist Status` and adds records to `Shortlisted Leads` for further review.

**When to run it:** To automatically shortlist candidates after their data has been compressed. Can be scheduled or triggered by events.
**Command:**
```bash
python shortlist.py
```

**Important:** Run `decompress.py` first to ensure all applicant data is properly synced and normalized before running `shortlist.py`. This guarantees that shortlisting is performed on the most up-to-date and accurate data.

### `llm_utils.py`

This module provides the `LLMClient` class for interacting with the Gemini API. It is used by scripts like `llm_evaluate.py` to send applicant profiles for evaluation, enforce token caps, handle errors, and log all LLM interactions. It does not itself perform applicant evaluation or update Airtable records; those tasks are handled by `llm_evaluate.py`.

**When to run it:** Run this after the `llm_evaluate.py` script to enrich your new applicant data. You can run it on a schedule (e.g., using a cron job) to automatically evaluate new entries.

**Command:**
```bash
python llm_utils.py
```

### `airtable_utils.py`

This module provides the `AirtableClient` class for all Airtable API interactions. It handles authentication, CRUD operations, error handling, and logging. All scripts—including `llm_evaluate.py`, `decompress.py`, and `shortlist.py`—use this utility to read from and write to Airtable tables in a consistent and maintainable way. Table and field names are managed via `config.py`.

---

## 4. Airtable Automations

### Lead Shortlisting

This automation runs entirely within Airtable to identify top candidates automatically.

#### Configuration

1.  **Trigger:** "When a record matches conditions".
    - **Table:** `Applicants`
    - **Fields:** Watch the `Shortlist Status` field. If it is set to `Shortlisted`, then automation is triggered.

2.  **Action:** "Create record".
    - **Table:** `Shortlisted Leads`
    - **Fields:**
        - All fields are updated from the Applicants folder except `Score Reason`.
        - `Score Reason`: Run shortlist.py to update easily.

#### Implementing Conditional Logic

Airtable Automations do not have complex, multi-layered conditional logic (if A OR B AND C). The best way to implement the shortlisting rules from the document is to create a **Formula Field** in the `Applicants` table that evaluates the conditions first.

##### Step-by-Step for Complex Shortlisting

Complex shortlisting logic can be implemented directly in Python using `shortlist.py`. This script allows you to define advanced criteria and apply them programmatically, making it more flexible and maintainable than Airtable formulas alone. You can still use formula fields for simple conditions, but for multi-layered logic, use or extend `shortlist.py`.

The psuedo code for the `shortlist.py` to shortlist candidates:
        ```
        IF(
            AND(
                OR({Total Experience} >= 4, {Worked at Tier 1} = 1),
                {Preferred Rate} <= 100,
                {Availability} >= 20,
                FIND({Location}, "US, Canada, UK, Germany, India") > 0
            ),
            "Yes",
            "No"
        )
        ```
This approach is much more robust and easier to debug than trying to build complex logic inside the automation itself.

---

## 5. Customization & Extensibility

### Modifying the LLM Prompt

To change what the AI evaluates, open `llm_utils.py` and edit the `PROMPT_TEMPLATE` string. You can ask it to perform different kinds of analysis, change the output format, or adjust the summary length.

### Adding New Utility Scripts

To add a new script for additional processing:
1. Create a new Python file in the project directory.
2. Implement the desired functionality, following the structure of existing scripts.
3. Add a new section in this document under "Python Scripts & Utilities Setup" with usage instructions.

---

## 6. Error Handling & Logging

This project emphasizes robust error handling and logging for easier maintenance and debugging.

### Error Handling

- Each script includes try-except blocks to handle potential errors gracefully.
- Validation checks are performed on data before processing to avoid runtime errors.

### Logging

- The `logging` module is used to log important events, errors, and debug information.
- Logs are written to a file named `app.log` in the project directory. Monitor this file for any issues during script execution.
- All utility modules and scripts (including `llm_utils.py`) use centralized logging for consistency and easier debugging.
- LLM calls in `llm_utils.py` include error handling, token cap enforcement, and exponential backoff, with all errors and retries logged for transparency.

---

## 7. Centralized Configuration

All configuration settings, such as API keys and base IDs, are stored in a `.env` file in the project directory. This file is loaded at runtime, and its values are used throughout the project via `config.py`. To change any configuration, update the `.env` file and restart the scripts. All utility modules and scripts read from `config.py`, which loads values from `.env` for consistency and maintainability.

---

## Useful Links

- [GitHub Repository](https://github.com/Peeyush4/Airtable-Tooling-Exercise)  
- [Airtable table](https://airtable.com/invite/l?inviteId=invrcAk031ns4rf6V&inviteToken=e3ef9f175796fbb61387ace754c094e2ec50fd9f62c5bdf7dc68fd9e93c2ce11&utm_medium=email&utm_source=product_team&utm_content=transactional-alerts)
- [Airtable API Documentation](https://airtable.com/api)
- [Google AI Studio (Gemini API)](https://aistudio.google.com/app/apikey)